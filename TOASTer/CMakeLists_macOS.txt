cmake_minimum_required(VERSION 3.15)

project(TOASTer VERSION 1.0.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_OSX_DEPLOYMENT_TARGET "10.13" CACHE STRING "" FORCE)

# Add JUCE
include(FetchContent)
FetchContent_Declare(
    JUCE
    GIT_REPOSITORY https://github.com/juce-framework/JUCE.git
    GIT_TAG 8.0.4
)
FetchContent_MakeAvailable(JUCE)

# Create the main application target
juce_add_gui_app(TOASTer
    PRODUCT_NAME "TOASTer"
    COMPANY_NAME "JAMNet"
    BUNDLE_ID "com.jamnet.toaster"
    VERSION "1.0.0"
)

# Add source files
target_sources(TOASTer PRIVATE
    Source/Main.cpp
    Source/MainComponent.cpp
    Source/ProfessionalTransportController.cpp
    Source/BasicMIDIPanel.cpp
    Source/ConnectionDiscovery.cpp
    Source/JAMNetworkPanel.cpp
    Source/JAMFrameworkIntegration.cpp
    Source/BonjourDiscovery.mm
    Source/ThunderboltNetworkDiscovery.cpp
    Source/WiFiNetworkDiscovery.cpp
    Source/PNBTRManager.cpp

    Source/GPUTransportController.cpp
)

# Configure JAM Framework v2 for GPU-native architecture - macOS SPECIFIC
set(JAM_GPU_BACKEND "metal" CACHE STRING "GPU backend for JAM Framework v2" FORCE)
set(JAM_ENABLE_GPU ON CACHE BOOL "Enable GPU acceleration" FORCE)
# DISABLED for macOS - use CoreAudio instead of JACK
set(JAM_ENABLE_JACK OFF CACHE BOOL "Disable JACK audio support on macOS" FORCE)

# Add JAM Framework v2 as a subdirectory
add_subdirectory(../JAM_Framework_v2 JAM_Framework_v2_build)

# Add include directories
target_include_directories(TOASTer PRIVATE
    ../JAM_Framework_v2/include
    ../JMID_Framework/include
    ../JDAT_Framework/include
    ../JVID_Framework/include
    ../PNBTR_Framework/include
)

# Link JUCE modules and JAM Framework v2
target_link_libraries(TOASTer PRIVATE
    juce::juce_gui_extra
    juce::juce_audio_devices
    juce::juce_recommended_config_flags
    juce::juce_recommended_lto_flags
    juce::juce_recommended_warning_flags
    jam_framework_v2
)

# Disable unneeded features
target_compile_definitions(TOASTer PRIVATE 
    JUCE_WEB_BROWSER=0 
    JUCE_USE_CURL=0
    JUCE_DISPLAY_SPLASH_SCREEN=0
    # Add macOS-specific audio backend definition
    JAM_USE_COREAUDIO=1
)

# macOS-specific frameworks for audio
if(APPLE)
    target_link_libraries(TOASTer PRIVATE
        "-framework CoreAudio"
        "-framework AudioUnit"
        "-framework AudioToolbox"
    )
endif() 